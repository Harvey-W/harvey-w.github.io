name: Sync Posts from Notion

on:
  schedule:
    - cron: "0 */12 * * *"   # æ¯12å°æ—¶è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:          # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  sync-notion:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT_FOR_ACTIONS }}
          submodules: true
          fetch-depth: 0

      - name: Verify Notion secret
        run: |
          if [ -z "${NOTION_SECRET}" ]; then
            echo "âŒ NOTION_SECRET is missing"
            exit 1
          else
            echo "âœ… NOTION_SECRET detected"
          fi
        env:
          NOTION_SECRET: ${{ secrets.NOTION_SECRET }}

      - name: Sync from Notion database
        uses: Harvey-W/notion-blog@master
        with:
          database-id: '28fd66f900a880469866f3c2ce540b14'
          content-folder: ./content/posts
          images-folder: ./static/img
          images-link: /img
          archetype-file: ./archetypes/blog.md
          property-description: "Description"
          property-tags: "Tags"
          property-categories: "Categories"
          filter-prop: 'Status'
          filter-value: "Finished,Published"
          published-value: 'Published'
          use-date-for-filename: true
          use-shortcodes: true
        env:
          NOTION_SECRET: ${{ secrets.NOTION_SECRET }}

      - name: Commit new or updated posts
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Actions"
      
          # æ·»åŠ æ‰€æœ‰å˜åŒ–ï¼ŒåŒ…æ‹¬æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤
          git add -A content/posts static/img
      
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
          if git diff --cached --quiet; then
            echo "No new, updated, or deleted posts."
          else
            # ç»Ÿè®¡ä¸åŒç±»å‹çš„å˜æ›´
            added=$(git diff --cached --name-status | grep "^A" | wc -l || true)
            modified=$(git diff --cached --name-status | grep "^M" | wc -l || true)
            deleted=$(git diff --cached --name-status | grep "^D" | wc -l || true)
            changed_files=$(git diff --cached --name-only | tr '\n' ',' | sed 's/,$//')
      
            # æ„é€  commit message
            commit_msg="ğŸª¶ Sync from Notion:"
            [ "$added" -gt 0 ] && commit_msg="$commit_msg ${added} added"
            [ "$modified" -gt 0 ] && commit_msg="$commit_msg, ${modified} updated"
            [ "$deleted" -gt 0 ] && commit_msg="$commit_msg, ${deleted} deleted"
      
            if [ -n "$changed_files" ]; then
              commit_msg="$commit_msg\nChanged files: ${changed_files}"
            fi
      
            # æäº¤å˜æ›´
            git commit -m "$commit_msg"
      
            # å°è¯•åŒæ­¥ä¸»åˆ†æ”¯
            if git pull --rebase origin main; then
              git push origin main
            else
              echo "âš ï¸ Merge conflict detected, skipping push to avoid overwrite."
              git rebase --abort || true
            fi
          fi
